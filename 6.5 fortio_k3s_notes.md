# Fortio 역할 및 k3s 실습 예시

Fortio는 **마이크로서비스/쿠버네티스 환경에서 트래픽을 생성해서 성능(지연/퍼센타일)과 오류율을 측정하는 부하 테스트 도구**입니다.  
(서비스 메시(Istio/Envoy) 성능 검증에도 자주 사용되며, 일반 HTTP/gRPC 부하 테스트에도 널리 활용됩니다.)

---

## 1. Fortio의 핵심 역할

### 1) 트래픽(부하) 생성기
- 원하는 **QPS(초당 요청 수)** 또는 **동시성(Concurrency)** 으로 요청을 생성합니다.
- HTTP/HTTPS, (환경에 따라) gRPC 등을 대상으로 테스트할 수 있습니다.

### 2) 지연시간/성능 측정기
- 평균뿐 아니라 **p50/p90/p99 퍼센타일 지연시간**을 제공합니다.
- “가끔 튀는 느린 요청(p99)”을 확인하는 데 유용합니다.

### 3) 오류율/상태코드 관측
- **상태코드 분포(200/500 등)**, 타임아웃, 연결 오류 등을 집계합니다.
- 성능 저하의 원인을 서버/네트워크/라우팅/프록시 관점에서 추정하는 데 도움이 됩니다.

### 4) 서비스 메시/인그레스/프록시 검증
- Istio/Envoy/Ingress Controller 앞뒤로 테스트해서
  - 프록시/사이드카 오버헤드
  - 라우팅 정책 변경 영향
  - mTLS, 리트라이/타임아웃 정책 효과
  등을 빠르게 비교할 수 있습니다.

### 5) 쿠버네티스 실습(HPA/리소스 튜닝)에서 유용
- Fortio로 지속 트래픽을 주면,
  - `kubectl top pods/nodes`로 리소스 상승 확인
  - HPA가 replica를 늘리는지 확인
  - 스로틀링/큐잉/레이트리밋 징후 확인  
  같은 실습이 명확해집니다.

---

## 2. k3s 실습용 빠른 예시

> 예시는 서비스가 `web-svc`(ClusterIP, port 80)이고 네임스페이스가 `demo`라고 가정합니다.

### 0) 사전: 테스트 대상 서비스 확인
```bash
kubectl -n demo get svc
kubectl -n demo get pod -o wide
```
---
```
ubuntu@cp1:~$ kubectl -n demo get svc
kubectl -n demo get pod -o wide
NAME      TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
web-svc   ClusterIP   10.43.31.179   <none>        80/TCP    5h38m
NAME                   READY   STATUS    RESTARTS   AGE     IP          NODE   NOMINATED NODE   READINESS GATES
web-79ffc79c64-wgc5c   1/1     Running   0          5h39m   10.42.1.8   w1     <none>           <none>
```
---

## A) 가장 빠른 1회성 테스트 (Fortio Pod 만들고 바로 삭제)

### 1) 테스트할 네임스페이스/서비스 지정 (여기만 바꾸면 됨)
```bash
NS=demo
SVC=web-svc
PORT=80
PATH=/
```

### 2) ClusterIP(Service DNS)로 부하 테스트
```bash
kubectl -n $NS run fortio --rm -it --restart=Never --image=fortio/fortio --   load -qps 20 -t 20s http://$SVC.$NS.svc.cluster.local:$PORT$PATH
```

출력에서 주로 확인:
- `Success` / `Errors`
- `Latency p50/p90/p99`

---

---
## 실해 후 주의 사항 - 컨테이너 인지 여부 판단 필요 - 위에서 - kubectl -n $NS run fortio --rm -it .... 으로 실행 했기 때문에
```
command -v kubectl || echo "kubectl 없음(컨테이너일 가능성↑)"
test -f /.dockerenv && echo "컨테이너(.dockerenv 있음)"
cat /proc/1/cgroup | head -n 5
```
---
```
ubuntu@cp1:~$ kubectl -n demo run fortio --rm -it --restart=Never --image=fortio/fortio -- \
  load -qps 50 -t 30s http://web-svc.demo.svc.cluster.local:80/
All commands and output from this session will be recorded in container logs, including credentials and sensitive information passed through the command prompt.
If you don't see a command prompt, try pressing enter.

08:15:53.689 r39 [INF] periodic.go:882> T000 ended after 30.014483648s : 375 calls. qps=12.493968058817096
08:15:53.691 r42 [INF] periodic.go:882> T003 ended after 30.016700502s : 375 calls. qps=12.49304532904987
08:15:53.695 r40 [INF] periodic.go:882> T001 ended after 30.020283275s : 375 calls. qps=12.491554345601024

중간생략

All done 1500 calls (plus 4 warmup) 10.070 ms avg, 50.0 qps
pod "fortio" deleted from demo namespace

ubuntu@cp1:~$ kubectl
-bash: kubectl: command not found
ubuntu@cp1:~$ exit
logout
Connection to 192.168.56.10 closed.
PS C:\Users\LG> ssh ubuntu@192.168.56.10
ubuntu@192.168.56.10's password:
Welcome to Ubuntu 22.04.5 LTS (GNU/Linux 5.15.0-164-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

This system has been minimized by removing packages and content that are
not required on a system that users do not log into.

To restore this content, you can run the 'unminimize' command.
New release '24.04.3 LTS' available.
Run 'do-release-upgrade' to upgrade to it.

Last login: Sat Jan 24 12:32:35 2026 from 192.168.56.1

재접속해도 같은 상태인 경우 파워쉘 별도 실행 필요

ubuntu@cp1:~$ kubectl -n $NS run fortio --rm -it --restart=Never --image=fortio/fortio --   load -qps 20 -t 20s http://$SVC.$NS.svc.cluster.local:$PORT$PATH
-bash: kubectl: command not found
```
## B) “서비스 이름을 모르겠다” → 자동으로 하나 골라 테스트

### 1) 서비스 목록 보기
```bash
NS=demo
kubectl -n $NS get svc
```

### 2) 첫 번째 서비스 하나를 자동 선택해서 테스트
```bash
NS=demo
SVC=$(kubectl -n $NS get svc -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | head -n 1)
PORT=$(kubectl -n $NS get svc $SVC -o jsonpath='{.spec.ports[0].port}')
kubectl -n $NS run fortio --rm -it --restart=Never --image=fortio/fortio --   load -qps 20 -t 20s http://$SVC.$NS.svc.cluster.local:$PORT/
```

---

## C) NodePort 서비스 테스트 (노드 IP로 때리기)

### 1) NodePort 확인
```bash
NS=demo
SVC=web-np
NODEPORT=$(kubectl -n $NS get svc $SVC -o jsonpath='{.spec.ports[0].nodePort}')
echo $NODEPORT
```

### 2) 노드 InternalIP 하나 뽑기
```bash
NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
echo $NODE_IP
```
---
```
ubuntu@cp1:~$ NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
echo $NODE_IP
192.168.56.10
```
### 3) 부하 테스트
```bash
kubectl -n $NS run fortio --rm -it --restart=Never --image=fortio/fortio --   load -qps 30 -t 20s http://$NODE_IP:$NODEPORT/
```

---

## D) 실습에 자주 쓰는 패턴 3종
```
2) WSL/리눅스에 fortio 설치하기 (옵션)

환경마다 설치법이 달라서, 보통은 Go 설치 후 빌드하거나 릴리즈 바이너리 다운로드로 가는데,
실습 목적이면 1번이 훨씬 빠르고 안정적입니다.

즉, 아래의 fortio 명령은 직접 설치 하여 실행하는 별도의 경우 임.
```
### 1) QPS 고정 (20초간 초당 50요청)
```bash
fortio load -qps 50 -t 20s http://<TARGET>/
```

### 2) 동시성 위주 (동시 32, 가능한 만큼 최대)
```bash
fortio load -c 32 -qps 0 -t 20s http://<TARGET>/
```

### 3) 조금 길게(2분) 안정화 보고 싶을 때
```bash
fortio load -qps 30 -t 2m http://<TARGET>/
```

---

## E) (옵션) HPA 실습용 “트래픽 계속 주기” + 모니터링

### 1) 트래픽 5분 주기
```bash
kubectl -n demo run fortio --rm -it --restart=Never --image=fortio/fortio --   load -qps 50 -t 5m http://web-svc.demo.svc.cluster.local:80/
```

### 2) 다른 터미널에서 관측
```bash
kubectl -n demo get hpa -w
kubectl -n demo get deploy,pod -w
kubectl top pods -n demo
```

---

## 3. 결과 해석에서 핵심 포인트(짧게)

- **Success % / Errors**: 실패(5xx/timeout)가 증가하면 용량/정책/네트워크 이슈 가능
- **Latency p50/p90/p99**
  - p50: “대부분”의 체감 지연
  - p99: “가끔 튀는 느린 요청” (프록시/재시도/GC/스로틀링 징후 등)


### sh 로 전체 분석 예시 chatgpt URL
https://chatgpt.com/share/697c5277-157c-8007-9cb4-6ead4254378e