# test.local(Host 기반) → Apache(80) 라우팅 구성 (Namespace=test)

> 목표  
> - 네임스페이스: `test`  
> - Apache(httpd) 컨테이너 포트: `80`  
> - Service: `apache-svc` (ClusterIP 80)  
> - Ingress: `Host: test.local` + `/` Prefix → `apache-svc:80`  
> - Ingress Controller: k3s 기본 Traefik 가정 (`ingressClassName: traefik`)

---

## 1) 올인원 YAML (Namespace + Deployment/Pod + Service + Ingress)

아래 내용을 파일로 저장 후 적용하세요. 예: `test-apache-ingress.yaml`

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: test
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apache
  namespace: test
  labels:
    app: apache
spec:
  replicas: 2
  selector:
    matchLabels:
      app: apache
  template:
    metadata:
      labels:
        app: apache
    spec:
      containers:
        - name: apache
          image: httpd:2.4-alpine
          ports:
            - name: http
              containerPort: 80
          readinessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 3
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /
              port: 80
            initialDelaySeconds: 10
            periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: apache-svc
  namespace: test
  labels:
    app: apache
spec:
  type: ClusterIP
  selector:
    app: apache
  ports:
    - name: http
      port: 80
      targetPort: 80
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: apache-ing
  namespace: test
spec:
  ingressClassName: traefik
  rules:
    - host: test.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: apache-svc
                port:
                  number: 80
```

---

## 2) 적용 & 리소스 확인

### 2.1 적용

```bash
kubectl apply -f test-apache-ingress.yaml
```

---
```
ubuntu@cp1:~$ kubectl apply -f ./test-apache-ingress.yaml
namespace/test created
deployment.apps/apache created
service/apache-svc created
ingress.networking.k8s.io/apache-ing created
```

### 2.2 생성/상태 확인

```bash
kubectl -n test get deploy,pod,svc,ingress -o wide
kubectl -n test get ep apache-svc -o wide
kubectl -n kube-system get svc traefik -o wide
```
---
```
ubuntu@cp1:~$ kubectl -n test get deploy,pod,svc,ingress -o wide
kubectl -n test get ep apache-svc -o wide
kubectl -n kube-system get svc traefik -o wide
NAME                     READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES             SELECTOR
deployment.apps/apache   2/2     2            2           45s   apache       httpd:2.4-alpine   app=apache

NAME                          READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES
pod/apache-744bf56f7c-527bd   1/1     Running   0          44s   10.42.2.17   w2     <none>           <none>
pod/apache-744bf56f7c-t8s7t   1/1     Running   0          44s   10.42.0.25   cp1    <none>           <none>

NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR
service/apache-svc   ClusterIP   10.43.117.129   <none>        80/TCP    45s   app=apache

NAME                                   CLASS     HOSTS        ADDRESS                                     PORTS   AGE
ingress.networking.k8s.io/apache-ing   traefik   test.local   192.168.56.10,192.168.56.11,192.168.56.12   80      44s
Warning: v1 Endpoints is deprecated in v1.33+; use discovery.k8s.io/v1 EndpointSlice
NAME         ENDPOINTS                     AGE
apache-svc   10.42.0.25:80,10.42.2.17:80   45s
NAME      TYPE           CLUSTER-IP      EXTERNAL-IP                                 PORT(S)                      AGE   SELECTOR
traefik   LoadBalancer   10.43.121.230   192.168.56.10,192.168.56.11,192.168.56.12   80:31300/TCP,443:31309/TCP   27d   app.kubernetes.io/instance=traefik-kube-system,app.kubernetes.io/name=traefik
```
---

정상 기대값:
- `apache` Pod 2개가 `Running` / `READY 1/1`
- `apache-svc` 의 endpoints가 `10.42.x.x:80` 형태로 채워짐
- `apache-ing` 의 `HOSTS` 에 `test.local` 표시

---

## 3) 접속 방법 (당신 환경 기준: Traefik EXTERNAL-IP=192.168.56.10/.11/.12, NodePort=31300)

당신이 앞에서 확인한 Traefik 서비스 형태(예시):

- `EXTERNAL-IP: 192.168.56.10, 192.168.56.11, 192.168.56.12`
- `PORTS: 80:31300/TCP`

즉 아래 두 가지 방식 중 하나로 접근 가능합니다. (환경에 따라 A만 되거나 B도 될 수 있음)

---

### A안) 정석/보편: NodePort로 접속

```bash
curl -i -H "Host: test.local" http://192.168.56.10:31300/ | head -n 20
```

---

### B안) 환경에 따라 80으로 바로 접속 가능

```bash
curl -i -H "Host: test.local" http://192.168.56.10:80/ | head -n 20
```

---

```
ubuntu@cp1:~$ curl -i -H "Host: test.local" http://192.168.56.10:80/ | head -n 20
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   191  100   191    0     0   6945      0 --:--:-- --:--:-- --:--:--  7346
HTTP/1.1 200 OK
Accept-Ranges: bytes
Content-Length: 191
Content-Type: text/html
Date: Fri, 30 Jan 2026 23:49:07 GMT
Etag: "bf-642fce432f300"
Last-Modified: Fri, 07 Nov 2025 08:23:08 GMT
Server: Apache/2.4.66 (Unix)

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>It works! Apache httpd</title>
</head>
<body>
<p>It works!</p>
</body>
</html>
ubuntu@cp1:~$
```

> 둘 중 하나만 성공해도 정상입니다.  
> (k3s/klipper-lb/iptables 구성에 따라 80이 직접 열릴 수도 있고 아닐 수도 있습니다.)

---

## 4) 브라우저에서 `http://test.local` 로 접속하려면 hosts 등록

### 4.1 Windows hosts 파일 위치
- `C:\Windows\System32\drivers\etc\hosts` (관리자 권한 필요)

### 4.2 내용 추가(예: Traefik으로 들어가는 노드 IP를 사용)

```txt
192.168.56.10  test.local
```

### 4.3 접속
- 브라우저: `http://test.local/`
- 또는 CLI:
```bash
curl -i http://test.local/ | head -n 20
```

---

## 5) 자주 겪는 증상과 의미

### 5.1 404가 뜬다
대부분 아래 이유입니다.

- **Host 헤더 없이** IP로 직접 접속해서 라우터 매칭이 실패  
  (Ingress에 `host: test.local`이 설정되어 있으면, Host가 맞지 않으면 404 가능)

예: (Host 없이 접속)
```bash
curl -i http://192.168.56.10:31300/ | head -n 20
```

해결(Host 헤더 추가)
```bash
curl -i -H "Host: test.local" http://192.168.56.10:31300/ | head -n 20
```

---

### 5.2 502/504가 뜬다
Ingress 매칭은 되었지만 **backend 쪽 문제**일 가능성이 큽니다.

가장 먼저 확인:
```bash
kubectl -n test get ep apache-svc -o wide
kubectl -n test get pod -o wide
```

- endpoints가 비어있으면: selector/label 불일치 또는 Pod Ready 문제 가능성

---

## 6) 참고: Ingress ADDRESS에 노드 IP가 여러 개 찍히는 이유

k3s/Traefik(klipper-lb) 환경에서는 Ingress가 진입점 주소로 **노드 IP 목록**을 보여주는 경우가 흔합니다.  
실제 트래픽은 “Traefik이 받는 노드 IP/포트(80 또는 NodePort)”를 통해 들어오게 됩니다.
